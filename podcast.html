<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Episodes</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <a href="index.html" class="back-link">‚Üê Back to Podcasts</a>
        <h1 id="podcast-title">Podcast Episodes</h1>
    </header>

    <main>
        <div class="podcast-container">
            <div class="episode-details" id="episode-details">
                <div class="season-episode-selectors">
                    <div class="selector-container">
                        <label for="season-dropdown">Season:</label>
                        <select id="season-dropdown" class="selector-dropdown">
                            <option value="">Select a season</option>
                        </select>
                    </div>
                    <div class="selector-container">
                        <label for="episodes-dropdown">Episode:</label>
                        <select id="episodes-dropdown" class="selector-dropdown">
                            <option value="">Select an episode</option>
                        </select>
                    </div>
                </div>
                <div class="episode-content">
                    <h2>Select a season and episode to view details</h2>
                    <p>Use the dropdowns above to select a season and episode to view its details and listen to it.</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get podcast ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const podcastId = urlParams.get('id') || 'plutot_caustique'; // Default to plutot_caustique if no ID provided

            // Set podcast title
            const podcastTitle = document.getElementById('podcast-title');
            podcastTitle.textContent = formatPodcastName(podcastId);

            // Load podcast data
            fetch(`podcasts/${podcastId}/episodes.json`)
                .then(response => response.json())
                .then(data => {
                    // Setup season dropdown
                    setupSeasonDropdown(data.Saisons);

                    // Setup initial episode dropdown with first season's episodes and display first episode
                    if (data.Saisons && data.Saisons.length > 0) {
                        const firstSeasonEpisodes = data.Saisons[0].episodes;
                        setupEpisodeDropdown(firstSeasonEpisodes);

                        // Select and display first episode by default
                        if (firstSeasonEpisodes.length > 0) {
                            const episodeDropdown = document.getElementById('episodes-dropdown');
                            episodeDropdown.value = 0;
                            displayEpisodeDetails(firstSeasonEpisodes[0]);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading podcast data:', error);
                    document.querySelector('.episode-content').innerHTML = '<p>Error loading podcast data. Please try again later.</p>';
                });

            // Handle season dropdown change
            document.getElementById('season-dropdown').addEventListener('change', function() {
                const seasonIndex = this.value;
                if (seasonIndex !== '') {
                    // Get podcast data again to access the episodes for the selected season
                    fetch(`podcasts/${podcastId}/episodes.json`)
                        .then(response => response.json())
                        .then(data => {
                            const episodes = data.Saisons[seasonIndex].episodes;
                            setupEpisodeDropdown(episodes);

                            // Select first episode by default and display its details
                            if (episodes.length > 0) {
                                const episodeDropdown = document.getElementById('episodes-dropdown');
                                episodeDropdown.value = 0;
                                displayEpisodeDetails(episodes[0]);
                            } else {
                                // If no episodes, reset episode content
                                document.querySelector('.episode-content').innerHTML = '<h2>No episodes available</h2><p>This season has no episodes available.</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading season episodes:', error);
                        });
                }
            });

            // Handle episode dropdown change
            document.getElementById('episodes-dropdown').addEventListener('change', function() {
                const episodeIndex = this.value;
                if (episodeIndex !== '') {
                    const episode = JSON.parse(this.options[this.selectedIndex].dataset.episode);
                    displayEpisodeDetails(episode);
                }
            });
        });

        function formatPodcastName(id) {
            // Convert podcast_id to a readable name (e.g., plutot_caustique -> Plutot Caustique)
            return id.split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function setupSeasonDropdown(seasons) {
            const seasonDropdown = document.getElementById('season-dropdown');
            seasonDropdown.innerHTML = '<option value="">Select a season</option>';

            seasons.forEach((season, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = season.name;
                seasonDropdown.appendChild(option);
            });

            // Select first season by default
            if (seasons.length > 0) {
                seasonDropdown.value = 0;
            }
        }

        function setupEpisodeDropdown(episodes) {
            const episodeDropdown = document.getElementById('episodes-dropdown');
            episodeDropdown.innerHTML = '<option value="">Select an episode</option>';

            episodes.forEach((episode, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = episode.episode;
                option.dataset.episode = JSON.stringify(episode);
                episodeDropdown.appendChild(option);
            });
        }

        function displayEpisodeDetails(episode) {
            const contentContainer = document.querySelector('.episode-content');

            // Clear the content container
            contentContainer.innerHTML = '';

            const title = document.createElement('h2');
            title.textContent = episode.episode;
            contentContainer.appendChild(title);

            const date = document.createElement('p');
            date.innerHTML = `<strong>Release Date:</strong> ${formatDate(episode.date)}`;
            contentContainer.appendChild(date);

            // Add labels if they exist
            if (episode.labels) {
                const labelsContainer = document.createElement('div');
                labelsContainer.className = 'labels-container';

                const labelsTitle = document.createElement('p');
                labelsTitle.innerHTML = '<strong>Labels:</strong>';
                labelsContainer.appendChild(labelsTitle);

                const labelsList = document.createElement('div');
                labelsList.className = 'labels-list';

                // Split the labels string by commas and create a span for each label
                episode.labels.split(',').forEach(label => {
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'label';
                    labelSpan.textContent = label.trim();
                    labelsList.appendChild(labelSpan);
                });

                labelsContainer.appendChild(labelsList);
                contentContainer.appendChild(labelsContainer);
            }

            const audioPlayer = document.createElement('audio');
            audioPlayer.className = 'audio-player';
            audioPlayer.controls = true;
            audioPlayer.src = episode.url;
            contentContainer.appendChild(audioPlayer);
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
    </script>
</body>
</html>
